{% extends "base.html" %}
{% block content %}
<div class="auth-container">
    <h1>{% if sp %}Edit Your Profile{% else %}Set Up Your Profile{% endif %}</h1>
    <p class="auth-subtitle">This is how car buyers will see you on CarsInStock</p>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <form method="POST" action="/profile/setup" enctype="multipart/form-data">
        
        <!-- Cover Photo -->
        <div class="form-group">
            <label>Cover Photo</label>
            <small style="color:#888;font-size:12px;display:block;margin-bottom:8px;">A wide banner image — your dealership, lot, or anything that represents your brand</small>
            <div class="cover-preview" id="coverPreview" onclick="document.getElementById('cover_photo').click()">
                {% if sp and sp.cover_photo %}
                    <img src="{{ sp.cover_photo }}" alt="Cover Photo" id="coverImg">
                {% else %}
                    <div class="cover-placeholder">
                        <span>+ Add Cover Photo</span>
                    </div>
                {% endif %}
            </div>
            <div style="display:flex;gap:8px;margin-top:8px;">
                <label for="cover_photo" class="photo-upload-btn">Choose Cover Photo</label>
                {% if sp and sp.cover_photo %}
                <button type="submit" formaction="/profile/remove-photo/cover" class="photo-remove-btn">Remove Cover</button>
                {% endif %}
            </div>
            <input type="file" id="cover_photo" name="cover_photo" accept="image/*" style="display:none;" onchange="previewCover(this)">
        </div>

        <!-- Profile Photo -->
        <div class="form-group" style="text-align:center; margin-bottom:28px;">
            <label style="text-align:left;">Profile Photo</label>
            <small style="color:#888;font-size:12px;display:block;margin-bottom:8px;text-align:left;">Your headshot — this appears next to your name on your storefront</small>
            <div class="photo-preview" id="photoPreview" onclick="document.getElementById('profile_photo').click()">
                {% if sp and sp.profile_photo %}
                    <img src="{{ sp.profile_photo }}" alt="Profile Photo" id="previewImg">
                {% else %}
                    <div class="photo-placeholder" id="placeholderIcon">
                        <span>{{ (sp.display_name[0] if sp and sp.display_name else "?") | upper }}</span>
                    </div>
                {% endif %}
            </div>
            <div style="display:flex;gap:8px;justify-content:center;margin-top:8px;">
                <label for="profile_photo" class="photo-upload-btn">Choose Profile Photo</label>
                {% if sp and sp.profile_photo %}
                <button type="submit" formaction="/profile/remove-photo/profile" class="photo-remove-btn">Remove Photo</button>
                {% endif %}
            </div>
            <input type="file" id="profile_photo" name="profile_photo" accept="image/*" style="display:none;" onchange="previewPhoto(this)">
        </div>

        <div class="form-group">
            <label for="display_name">Display Name *</label>
            <input type="text" id="display_name" name="display_name" value="{{ display_name }}" placeholder="e.g. Eddie Castillo" required>
            <small style="color:#888;font-size:12px;">This creates your personal URL: carsinstock.com/eddie-castillo</small>
        </div>
        <div class="form-group">
            <label for="phone">Phone Number</label>
            <input type="tel" id="phone" name="phone" value="{{ phone }}" placeholder="(555) 123-4567">
        </div>
        <div class="form-group">
            <label for="bio">Bio</label>
            <textarea id="bio" name="bio" rows="4" placeholder="Tell buyers about yourself, your experience, and what makes you different..." style="width:100%;padding:12px 14px;border:2px solid #ddd;border-radius:8px;font-size:16px;font-family:inherit;resize:vertical;box-sizing:border-box;">{{ bio }}</textarea>
            <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <button type="button" onclick="generateBio()" class="ai-btn" id="aiBioBtn">&#10024; Write My Bio with AI</button>
                <input type="text" id="bioYears" placeholder="Years experience" style="width:120px;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:13px;">
                <input type="text" id="bioDealership" placeholder="Dealership name" style="width:150px;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:13px;">
            </div>
        </div>
        <button type="submit" class="btn-primary">{% if sp %}Update Profile{% else %}Create Profile{% endif %}</button>
    </form>
    {% if sp and sp.profile_url_slug %}
    <p class="auth-footer" style="margin-top:24px;">
        Your storefront: <a href="/{{ sp.profile_url_slug }}" style="color:#2d1d36;font-weight:600;">carsinstock.com/{{ sp.profile_url_slug }}</a>
    </p>
    {% endif %}
</div>
<script>
function previewPhoto(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('photoPreview').innerHTML = '<img src="' + e.target.result + '" alt="Preview" id="previewImg">';
        }
        reader.readAsDataURL(input.files[0]);
    }
}
function previewCover(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('coverPreview').innerHTML = '<img src="' + e.target.result + '" alt="Cover Preview" id="coverImg">';
        }
        reader.readAsDataURL(input.files[0]);
    }
}
</script>
<style>
    .auth-container { max-width: 520px; margin: 40px auto; padding: 40px; background: #fff; border-radius: 12px; box-shadow: 0 2px 16px rgba(45,29,54,0.10); }
    .auth-container h1 { color: #2d1d36; margin-bottom: 8px; font-size: 28px; }
    .auth-subtitle { color: #666; margin-bottom: 30px; font-size: 14px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #2d1d36; font-size: 14px; }
    .form-group input[type="text"], .form-group input[type="tel"] { width: 100%; padding: 12px 14px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; transition: border-color 0.2s; box-sizing: border-box; }
    .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #2d1d36; }
    .btn-primary { width: 100%; padding: 14px; background: #2d1d36; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    .btn-primary:hover { background: #3d2a4a; }
    .auth-footer { text-align: center; color: #666; font-size: 14px; }
    .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; }
    .alert-error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
    .alert-success { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
    .cover-preview { width: 100%; height: 180px; border-radius: 12px; overflow: hidden; background: #f0f0f0; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: border-color 0.2s; }
    .cover-preview:hover { border-color: #2d1d36; }
    .cover-preview img { width: 100%; height: 100%; object-fit: cover; }
    .cover-placeholder { text-align: center; }
    .cover-placeholder span { color: #999; font-size: 16px; font-weight: 600; }
    .photo-preview { width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 12px; overflow: hidden; background: #2d1d36; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: opacity 0.2s; }
    .photo-preview:hover { opacity: 0.85; }
    .photo-preview img { width: 100%; height: 100%; object-fit: cover; }
    .photo-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
    .photo-placeholder span { color: white; font-size: 48px; font-weight: 700; }
    .photo-upload-btn { display: inline-block; padding: 8px 20px; background: #f0f0f0; color: #2d1d36; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    .photo-upload-btn:hover { background: #e0e0e0; }
    .photo-remove-btn { padding: 8px 20px; background: none; color: #dc2626; border: 1px solid #dc2626; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .photo-remove-btn:hover { background: #dc2626; color: white; }
    .ai-btn { padding: 8px 16px; background: linear-gradient(135deg, #6C2BD9, #1a73e8); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
    .ai-btn:hover { opacity: 0.9; }
    .ai-btn:disabled { opacity: 0.5; cursor: not-allowed; }
</style>
<script>
function generateBio() {
    var btn = document.getElementById('aiBioBtn');
    var name = document.getElementById('display_name').value;
    var years = document.getElementById('bioYears').value;
    var dealership = document.getElementById('bioDealership').value;
    if (!name) { alert('Enter your display name first'); return; }
    btn.innerHTML = '&#10024; Writing...';
    btn.disabled = true;
    fetch('/api/generate-bio', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name: name, years: years, dealership: dealership})
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            document.getElementById('bio').value = data.bio;
        } else {
            alert('Could not generate bio. Try again.');
        }
        btn.innerHTML = '&#10024; Write My Bio with AI';
        btn.disabled = false;
    })
    .catch(function() {
        alert('Error connecting. Try again.');
        btn.innerHTML = '&#10024; Write My Bio with AI';
        btn.disabled = false;
    });
}
</script>
{% endblock %}
